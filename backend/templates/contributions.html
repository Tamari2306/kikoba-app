{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold"><i class="fas fa-hand-holding-usd me-2 text-success"></i>Contributions</h1>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addContributionModal">
        <i class="fas fa-plus me-1"></i> Add Contribution
    </button>
</div>

<!-- Add Contribution Modal -->
<div class="modal fade" id="addContributionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Add Contribution</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-contribution-form">
                    <div class="mb-3">
                        <label class="form-label">Member</label>
                        <select class="form-control" id="contributionMember" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-control" id="contributionType" required>
                            <option value="hisa">Hisa</option>
                            <option value="hisa anzia">Hisa Anzia</option>
                            <option value="jamii">Jamii (Optional)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (TZS)</label>
                        <input type="number" class="form-control" id="contributionAmount" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Entry Date</label>
                        <input type="date" class="form-control" id="contributionDate" required>
                        <small class="text-muted">When this record was entered</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Transaction Date</label>
                        <input type="date" class="form-control" id="contributionTransactionDate" required>
                        <small class="text-muted">When the actual transaction occurred</small>
                    </div>
                    <button class="btn btn-success w-100"><i class="fas fa-save me-1"></i> Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Contribution Modal -->
<div class="modal fade" id="editContributionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Edit Contribution</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-contribution-form">
                    <input type="hidden" id="editContributionId">
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-control" id="editContributionType" required>
                            <option value="hisa">Hisa</option>
                            <option value="hisa anzia">Hisa Anzia</option>
                            <option value="jamii">Jamii</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (TZS)</label>
                        <input type="number" class="form-control" id="editContributionAmount" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Entry Date</label>
                        <input type="date" class="form-control" id="editContributionDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Transaction Date</label>
                        <input type="date" class="form-control" id="editContributionTransactionDate" required>
                    </div>
                    <button class="btn btn-warning w-100"><i class="fas fa-save me-1"></i> Update</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="alert alert-info">
    <strong>ℹ️ Note:</strong> Jamii is now optional and will be returned to members at cycle end, just like Hisa contributions.
</div>

<!-- Contributions Table -->
<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-success">
                <tr>
                    <th>Member</th>
                    <th>Type</th>
                    <th class="text-end">Amount</th>
                    <th>Entry Date</th>
                    <th>Transaction Date</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="contributionsTableBody"></tbody>
        </table>
    </div>
</div>

<script>
const API = "/api/contributions";
const MEMBERS_API = "/api/members";

async function loadMembers() {
    const res = await fetch(MEMBERS_API);
    const members = await res.json();
    const select = document.getElementById("contributionMember");
    select.innerHTML = members.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
}

async function loadContributions() {
    const res = await fetch(API);
    const contributions = await res.json();
    const tbody = document.getElementById("contributionsTableBody");

    tbody.innerHTML = contributions.map(c => {
        const typeLabel = c.type === 'jamii' ? 
            `<span class="badge bg-info">${c.type}</span>` : 
            `<span class="badge bg-primary">${c.type}</span>`;
        
        // FIX: Use transaction_date if available, otherwise fall back to date
        const displayTransactionDate = c.transaction_date || c.date || 'N/A';
        
        return `
            <tr>
                <td class="fw-bold">${c.member_name}</td>
                <td>${typeLabel}</td>
                <td class="text-end"><strong>${(c.amount || 0).toLocaleString()} TZS</strong></td>
                <td>${c.date || 'N/A'}</td>
                <td>${displayTransactionDate}</td>
                <td class="text-center">
                    ${c.type !== 'jamii_deduction' ? `
                        <button class="btn btn-sm btn-outline-warning edit-btn" 
                                data-id="${c.id}" 
                                data-type="${c.type}" 
                                data-amount="${c.amount}" 
                                data-date="${c.date || ''}"
                                data-transaction-date="${displayTransactionDate}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${c.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : '<span class="text-muted">System</span>'}
                </td>
            </tr>
        `;
    }).join("");

    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', handleEdit);
    });
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', handleDelete);
    });
}

function handleEdit(e) {
    const btn = e.currentTarget;
    document.getElementById('editContributionId').value = btn.dataset.id;
    document.getElementById('editContributionType').value = btn.dataset.type;
    document.getElementById('editContributionAmount').value = btn.dataset.amount;
    document.getElementById('editContributionDate').value = btn.dataset.date;
    document.getElementById('editContributionTransactionDate').value = btn.dataset.transactionDate;
    new bootstrap.Modal(document.getElementById('editContributionModal')).show();
}

async function handleDelete(e) {
    const id = e.currentTarget.dataset.id;
    if (!confirm('Delete this contribution?')) return;

    try {
        const res = await fetch(`${API}/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (res.ok) {
            alert(data.message || 'Contribution deleted');
            loadContributions();
        } else {
            alert(data.error || 'Failed to delete');
        }
    } catch (error) {
        alert('Network error');
        console.error(error);
    }
}

document.getElementById("add-contribution-form").addEventListener("submit", async e => {
    e.preventDefault();
    const member_id = contributionMember.value;
    const type = contributionType.value;
    const amount = contributionAmount.value;
    const date = contributionDate.value;
    const transaction_date = contributionTransactionDate.value;

    const res = await fetch(API, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ member_id, type, amount, date, transaction_date })
    });

    if (res.ok) {
        bootstrap.Modal.getInstance(addContributionModal).hide();
        e.target.reset();
        loadContributions();
    } else {
        alert("Failed to add contribution");
    }
});

document.getElementById("edit-contribution-form").addEventListener("submit", async e => {
    e.preventDefault();
    const id = document.getElementById('editContributionId').value;
    const type = document.getElementById('editContributionType').value;
    const amount = document.getElementById('editContributionAmount').value;
    const date = document.getElementById('editContributionDate').value;
    const transaction_date = document.getElementById('editContributionTransactionDate').value;

    try {
        const res = await fetch(`${API}/${id}`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ type, amount, date, transaction_date })
        });

        const data = await res.json();
        if (res.ok) {
            alert(data.message || 'Contribution updated');
            bootstrap.Modal.getInstance(document.getElementById('editContributionModal')).hide();
            loadContributions();
        } else {
            alert(data.error || 'Failed to update');
        }
    } catch (error) {
        alert('Network error');
        console.error(error);
    }
});

// Set today's date as default
document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('contributionDate').value = today;
    document.getElementById('contributionTransactionDate').value = today;
    
    loadMembers();
    loadContributions();
});
</script>

{% endblock %}