{% extends "base.html" %}
{% block content %}

<div class="mb-4">
    <h1 class="fw-bold"><i class="fas fa-chart-line me-2 text-success"></i>Profit Distribution</h1>
    <p class="text-muted">Calculate and distribute profits based on HISA units (includes both Hisa and Jamii contributions)</p>
</div>

<div class="alert alert-info">
    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>How Profit Distribution Works</h5>
    <ul class="mb-0">
        <li><strong>Profit Sources:</strong> Interest from loans + Penalties collected</li>
        <li><strong>Deductions:</strong> Leadership Pay only</li>
        <li><strong>Distribution Method:</strong> Net profit divided equally among all HISA units</li>
        <li><strong>Member Payout:</strong> Savings (Hisa + Jamii) + Profit Share - Loans Due - Penalties Due</li>
        <li><strong>⚠️ Important:</strong> Jamii is NO LONGER deducted from profits - it's returned to members like regular savings!</li>
    </ul>
</div>

<button id="calculateBtn" class="btn btn-success btn-lg mb-4">
    <i class="fas fa-calculator me-2"></i> Calculate Profit Distribution
</button>

<!-- Results Section -->
<div id="resultsSection" class="d-none">
    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <h6 class="text-muted">Total Interest</h6>
                    <h4 id="totalInterest" class="text-primary mb-0">0 TZS</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="text-muted">Total Penalties</h6>
                    <h4 id="totalPenalties" class="text-warning mb-0">0 TZS</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body">
                    <h6 class="text-muted">Leadership Pay</h6>
                    <h4 id="leadershipPay" class="text-danger mb-0">0 TZS</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="text-muted">Net Profit to Distribute</h6>
                    <h4 id="netProfit" class="text-success mb-0">0 TZS</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="text-muted">Total HISA Units</h6>
                    <h4 id="totalUnits" class="text-info mb-0">0 units</h4>
                    <small class="text-muted">From Hisa</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="text-muted">Profit Per Unit</h6>
                    <h4 id="profitPerUnit" class="text-success mb-0">0 TZS</h4>
                    <small class="text-muted">Each unit gets this amount</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-secondary">
                <div class="card-body">
                    <h6 class="text-muted">Gross Pool</h6>
                    <h4 id="grossPool" class="text-secondary mb-0">0 TZS</h4>
                    <small class="text-muted">Interest + Penalties</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Breakdown -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Member Profit Distribution</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Member</th>
                        <th class="text-end">HISA Units</th>
                        <th class="text-end">Savings (Anzia+Hisa+Jamii)</th>
                        <th class="text-end">Profit Share</th>
                        <th class="text-end text-danger">Loans Due</th>
                        <th class="text-end text-warning">Penalties Due</th>
                        <th class="text-end">Total Deductions</th>
                        <th class="text-end text-success">Final Payout</th>
                    </tr>
                </thead>
                <tbody id="breakdownTable"></tbody>
            </table>
        </div>
    </div>

    <!-- Export Button -->
    <div class="mt-4">
        <button id="exportBtn" class="btn btn-outline-primary">
            <i class="fas fa-download me-2"></i> Export to Excel
        </button>
    </div>
</div>

<script>
function formatTZS(v) {
    return (v || 0).toLocaleString() + " TZS";
}

document.getElementById("calculateBtn").addEventListener("click", async () => {
    try {
        const res = await fetch("/api/profits", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({})
        });

        const data = await res.json();

        if (!res.ok) {
            alert(data.error || "Failed to calculate profits");
            return;
        }

        // Display summary
        document.getElementById("totalInterest").textContent = formatTZS(data.total_interest);
        document.getElementById("totalPenalties").textContent = formatTZS(data.total_penalties);
        document.getElementById("leadershipPay").textContent = formatTZS(data.leadership_pay_amount);
        document.getElementById("grossPool").textContent = formatTZS(data.gross_distributable_pool);
        document.getElementById("netProfit").textContent = formatTZS(data.net_profit_to_distribute);
        document.getElementById("totalUnits").textContent = data.total_hisa_units.toFixed(2) + " units";
        document.getElementById("profitPerUnit").textContent = formatTZS(data.profit_per_unit);

        // Display member breakdown
        const tbody = document.getElementById("breakdownTable");
        tbody.innerHTML = data.breakdown.map(m => `
            <tr>
                <td class="fw-bold">${m.member_name}</td>
                <td class="text-end">${m.hisa_units.toFixed(2)}</td>
                <td class="text-end">${formatTZS(m.savings)}</td>
                <td class="text-end text-success">${formatTZS(m.profit_share)}</td>
                <td class="text-end text-danger">${formatTZS(m.loan_balance_due)}</td>
                <td class="text-end text-warning">${formatTZS(m.penalties_due)}</td>
                <td class="text-end">${formatTZS(m.total_deductions)}</td>
                <td class="text-end text-success"><strong>${formatTZS(m.total_payout)}</strong></td>
            </tr>
        `).join("");

        document.getElementById("resultsSection").classList.remove("d-none");

        // Store data for export
        window.profitData = data;

    } catch (error) {
        console.error("Error:", error);
        alert("Failed to calculate profits. Please try again.");
    }
});

document.getElementById("exportBtn").addEventListener("click", () => {
    if (!window.profitData) {
        alert("Please calculate profits first");
        return;
    }

    const data = window.profitData;
    
    let csv = "Member,HISA Units,Savings (Anzia+Hisa+Jamii),Profit Share,Loans Due,Penalties Due,Total Deductions,Final Payout\n";
    
    data.breakdown.forEach(m => {
        csv += `"${m.member_name}",${m.hisa_units.toFixed(2)},${m.savings},${m.profit_share},${m.loan_balance_due},${m.penalties_due},${m.total_deductions},${m.total_payout}\n`;
    });

    csv += `\nSummary\n`;
    csv += `Total Interest,${data.total_interest}\n`;
    csv += `Total Penalties,${data.total_penalties}\n`;
    csv += `Leadership Pay,${data.leadership_pay_amount}\n`;
    csv += `Net Profit Distributed,${data.net_profit_to_distribute}\n`;
    csv += `Total HISA Units,${data.total_hisa_units.toFixed(2)}\n`;
    csv += `Profit Per Unit,${data.profit_per_unit.toFixed(2)}\n`;

    const blob = new Blob([csv], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `profit_distribution_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
});
</script>

{% endblock %}