@app.route('/api/profits', methods=['POST'])
def calculate_profits():
    db = get_db()
    group_id = get_current_group_id()

    if not group_id:
        return jsonify({"error": "No active group"}), 400

    data = request.get_json() or {}
    temp_jamii_used = float(data.get("jamii_used", 0))
    method = data.get("method", "cash")

    profit_data = get_current_group_profit(db, group_id)

    total_jamii_expense = profit_data["historical_jamii_spent"] + temp_jamii_used

    net_profit = max(
        profit_data["gross_distributable_pool"]
        - profit_data["leadership_pay_amount"]
        - total_jamii_expense,
        0
    )

    total_savings = get_total_savings(db, group_id)
    if total_savings <= 0:
        return jsonify({
            "error": "No Hisa available for profit distribution",
            "net_profit_to_distribute": 0,
            "breakdown": []
        })

    admin_id = get_group_admin_member_id(db, group_id)

    members = db.execute(
        """
        SELECT id, name
        FROM members
        WHERE group_id = ?
        AND id != ?
        """,
        (group_id, admin_id)
    ).fetchall()

    results = []

    for m in members:
        member_id = m["id"]

        savings = db.execute(
            """
            SELECT SUM(amount)
            FROM contributions
            WHERE member_id = ?
              AND group_id = ?
              AND type IN ('hisa', 'hisa anzia')
            """,
            (member_id, group_id)
        ).fetchone()[0] or 0

        share_ratio = savings / total_savings
        profit_share = round(net_profit * share_ratio)

        loan_balances = get_member_loan_balances(db, member_id, group_id)
        penalties_due = get_total_penalties_due_for_member(member_id, db, group_id)
        jamii_status = get_member_jamii_balance(db, member_id, group_id)

        total_deductions = (
            loan_balances["remaining_loans"]
            + penalties_due
            + jamii_status["shortfall"]
        )

        final_payout = max((savings + profit_share) - total_deductions, 0)

        results.append({
            "member_name": m["name"],
            "savings": savings,
            "profit_share": profit_share,
            "loan_balance_due": loan_balances["remaining_loans"],
            "penalties_due": penalties_due,
            "jamii_shortfall": jamii_status["shortfall"],
            "total_deductions": total_deductions,
            "total_payout": final_payout
        })

    return jsonify({
        "net_profit_to_distribute": net_profit,
        "leadership_pay_amount": profit_data["leadership_pay_amount"],
        "gross_distributable_pool": profit_data["gross_distributable_pool"],
        "historical_jamii_spent": profit_data["historical_jamii_spent"],
        "total_jamii_expenses": total_jamii_expense,
        "breakdown": results
    })

@app.route('/api/reports', methods=['GET'])
def get_report_data():
    db = get_db()
    group_id = get_current_group_id()

    if not group_id:
        return jsonify({"error": "No active group"}), 400

    profit_data = get_current_group_profit(db, group_id)
    total_profit = profit_data["net_profit_to_distribute"]
    total_savings = get_total_savings(db, group_id)

    admin_id = get_group_admin_member_id(db, group_id)

    members = db.execute(
        """
        SELECT id, name
        FROM members
        WHERE group_id = ?
        AND id != ?
        """,
        (group_id, admin_id)
    ).fetchall()

    report_data = []

    for m in members:
        member_id = m["id"]

        contribs = db.execute(
            """
            SELECT type, SUM(amount) AS total
            FROM contributions
            WHERE member_id = ?
              AND group_id = ?
              AND type != 'jamii_deduction'
            GROUP BY type
            """,
            (member_id, group_id)
        ).fetchall()

        contrib_dict = {c["type"]: c["total"] for c in contribs}

        hisa_base = (
            contrib_dict.get("hisa", 0)
            + contrib_dict.get("hisa anzia", 0)
        )

        loan_balances = get_member_loan_balances(db, member_id, group_id)
        penalties_due = get_total_penalties_due_for_member(member_id, db, group_id)
        jamii_status = get_member_jamii_balance(db, member_id, group_id)

        net_position = (
            hisa_base
            - loan_balances["remaining_loans"]
            - penalties_due
            - jamii_status["shortfall"]
        )

        expected_profit_share = (
            round((hisa_base / total_savings) * total_profit)
            if total_savings > 0 else 0
        )

        report_data.append({
            "member_name": m["name"],
            "contributions": contrib_dict,
            "total_contributions": sum(contrib_dict.values()),
            "total_loans": loan_balances["total_loans_committed"],
            "total_rejesho": loan_balances["total_rejesho"],
            "remaining_loans": loan_balances["remaining_loans"],
            "total_penalties": penalties_due,
            "jamii_paid": jamii_status["total_paid"],
            "jamii_expected": jamii_status["expected_total"],
            "jamii_shortfall": jamii_status["shortfall"],
            "expected_profit_share": expected_profit_share,
            "net_payout": net_position + expected_profit_share
        })

    return jsonify({"report": report_data})